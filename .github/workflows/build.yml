on: push
jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        target: [x86_64-linux-android, i686-linux-android, aarch64-linux-android, armv7-linux-androideabi]
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@master
      - env:
          TARGET: ${{ matrix.target }}
        run: |
          rustup update
          rustup target add $TARGET
          ./build-termux.sh
          tar czf release.tar.gz -C target/$TARGET/debug okc-ssh-agent okc-gpg
      - if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
        run: |
          git fetch --unshallow --tags
          curl -fsS -T release.tar.gz \
              -u ddosolitary:${{ secrets.BINTRAY_KEY }} \
              -H "X-Bintray-Package: default" \
              -H "X-Bintray-Version: default" \
              -H "X-Bintray-Publish: 1" \
              https://api.bintray.com/content/ddosolitary/dev-releases/okc-agents/okc-agents-$(git describe --tags)-$(echo ${{ matrix.target }} | cut -d - -f 1).tar.gz
